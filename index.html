<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Authentication API Test (Face ID)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      #credentialDisplay {
        margin-top: 20px;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #f9f9f9;
      }
      .credential-item {
        margin: 5px 0;
        padding: 5px;
        border: 1px solid #007bff;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Web Authentication API (Biometric Authentication with Face ID)</h1>
    <button id="registerButton">Register Face ID</button>
    <button id="authButton">Authenticate with Face ID</button>

    <div id="credentialDisplay" style="display: none">
      <h2>Registered Credential</h2>
      <div class="credential-item">
        <strong>Credential ID:</strong> <span id="credentialId"></span>
      </div>
      <div class="credential-item">
        <strong>Raw ID:</strong> <span id="rawId"></span>
      </div>
      <div class="credential-item">
        <strong>Response:</strong> <span id="response"></span>
      </div>
      <div class="credential-item">
        <strong>Credentials Received:</strong>
        <span id="credentialsReceived"></span>
      </div>
    </div>

    <script>
      // Register Face ID (or biometric authenticator)
      document
        .getElementById("registerButton")
        .addEventListener("click", () => {
          if ("credentials" in navigator) {
            const options = {
              publicKey: {
                challenge: new Uint8Array(32), // Secure random challenge (replace with a real challenge from your server)
                rp: {
                  name: "Your App Name",
                },
                user: {
                  id: new Uint8Array(16), // User ID, should be unique and secure
                  name: "user@example.com", // User's email or username
                  displayName: "User Name",
                },
                pubKeyCredParams: [
                  {
                    type: "public-key",
                    alg: -7, // ES256 algorithm
                  },
                ],
                timeout: 60000, // 60 seconds timeout
                authenticatorSelection: {
                  authenticatorAttachment: "platform", // Use platform authenticator (built-in biometric hardware)
                  userVerification: "required", // Require user verification (e.g., Face ID or fingerprint)
                },
                attestation: "direct", // Attestation type
              },
            };

            navigator.credentials
              .create(options)
              .then((credential) => {
                console.log("Registration successful:", credential);

                // Save credential data (for demonstration purposes)
                const savedData = {
                  credentialId: credential.id,
                  rawId: new Uint8Array(credential.rawId),
                  response: credential.response,
                };
                localStorage.setItem(
                  "credentialData",
                  JSON.stringify(savedData)
                );

                // Display credential information
                document.getElementById("credentialId").textContent =
                  credential.id;
                document.getElementById("rawId").textContent = new Uint8Array(
                  credential.rawId
                ).toString();
                document.getElementById("response").textContent =
                  JSON.stringify(credential.response);
                document.getElementById("credentialDisplay").style.display =
                  "block";

                alert("Face ID Registration successful and data saved!");
              })
              .catch((error) => {
                console.error("Registration failed:", error);
              });
          } else {
            console.error("Web Authentication API not supported.");
          }
        });

      // Authenticate using Face ID
      document.getElementById("authButton").addEventListener("click", () => {
        const savedCredential = JSON.parse(
          localStorage.getItem("credentialData")
        );

        if (!savedCredential) {
          alert("No credential found. Please register first.");
          return;
        }

        if ("credentials" in navigator) {
          const options = {
            publicKey: {
              challenge: new Uint8Array(32), // Secure random challenge (replace with server-side challenge)
              allowCredentials: [
                {
                  id: new Uint8Array(savedCredential.rawId), // Use saved credential raw ID
                  type: "public-key",
                },
              ],
              userVerification: "required", // Ensure biometric verification (e.g., Face ID)
            },
          };

          navigator.credentials
            .get(options)
            .then((credential) => {
              if (credential) {
                // Compare credential.id with the saved one
                if (credential.id === savedCredential.credentialId) {
                  alert("Authentication successful using Face ID!");
                  console.log("Authentication successful:", credential);
                } else {
                  alert("Authentication failed: Credential mismatch.");
                }
              }
            })
            .catch((error) => {
              console.error("Authentication failed:", error);
            });
        } else {
          console.error("Web Authentication API not supported.");
        }
      });
    </script>
  </body>
</html>
